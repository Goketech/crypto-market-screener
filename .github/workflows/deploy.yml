name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  # PHASE 1: CONTINUOUS INTEGRATION (Testing)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Lint with flake8 (Check for syntax errors)
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

  # PHASE 2: CONTINUOUS DEPLOYMENT (Updating Servers)
  deploy:
    needs: build-and-test # Only deploy if tests pass
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Web Servers
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        # The script to run on your servers:
        script: |
          # 1. Go to the project folder (Adjust this path if yours is different!)
          cd ~/crypto-market-screener
          
          # 2. Pull the latest code
          git pull origin main
          
          # 3. Update dependencies if any changed
          pip install -r requirements.txt
          
          # 4. Restart the web server (Gunicorn/Nginx)
          # Assuming you are running gunicorn manually or as a service:
          sudo systemctl restart nginx
          # If you have a gunicorn service, uncomment below:
          # sudo systemctl restart myapp
